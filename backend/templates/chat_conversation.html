{% extends "base.html" %}

{% block title %}Chat with {{ other_user.username }} - Rent & Billing System{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
    <h2>
        <i class="fas fa-comment me-2"></i>
        <span class="d-none d-sm-inline">Chat with {{ other_user.username }}</span>
        <span class="d-sm-none">{{ other_user.username }}</span>
        {% if not current_user.is_admin %}
            <small class="text-muted">(Admin)</small>
        {% else %}
            <small class="text-muted">(Room {{ other_user.room_number }})</small>
        {% endif %}
    </h2>
    <div>
        <button class="btn btn-outline-secondary btn-sm me-2" onclick="toggleDarkMode()" id="darkModeToggle">
            <i class="fas fa-moon me-1"></i>
            <span class="d-none d-sm-inline">Dark Mode</span>
        </button>
        {% if current_user.is_admin %}
            <a href="{{ url_for('chat_dashboard') }}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>
                <span class="d-none d-sm-inline">Back to Dashboard</span>
                <span class="d-sm-none">Back</span>
            </a>
        {% else %}
            <a href="{{ url_for('renter_dashboard') }}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>
                <span class="d-none d-sm-inline">Back to Dashboard</span>
                <span class="d-sm-none">Back</span>
            </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-comments me-2"></i>
                Conversation
                <span class="badge bg-light text-dark ms-2" id="connection-status">Connected</span>
            </div>
            <div class="card-body chat-container" style="height: 50vh; min-height: 300px; overflow-y: auto;" id="chat-messages">
                {% if messages %}
                    {% for message in messages %}
                    <div class="message mb-3 {% if message.sender_id == current_user.id %}text-end{% endif %}">
                        <div class="message-bubble 
                             {% if message.sender_id == current_user.id %}bg-primary text-white ms-auto{% else %}bg-light{% endif %}"
                             style="display: inline-block; padding: 10px 15px; border-radius: 18px; max-width: 70%; word-wrap: break-word;">
                            <div class="message-content">{{ message.message }}</div>
                            <small class="message-time d-block mt-1 
                                   {% if message.sender_id == current_user.id %}text-white-50{% else %}text-muted{% endif %}">
                                {{ message.created_at.strftime('%m/%d %H:%M') }}
                                {% if message.sender_id == current_user.id %}
                                    <i class="fas fa-check{% if message.is_read %}-double text-info{% endif %} ms-1"></i>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted mt-4">
                        <i class="fas fa-comment-dots fa-3x mb-3"></i>
                        <h5>No messages yet</h5>
                        <p>Start the conversation by sending a message below!</p>
                    </div>
                {% endif %}
                <div id="typing-indicator" class="d-none">
                    <div class="message mb-3">
                        <div class="message-bubble bg-light" style="display: inline-block; padding: 10px 15px; border-radius: 18px;">
                            <span class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </span>
                            <small class="text-muted">{{ other_user.username }} is typing...</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <form id="message-form" class="d-flex gap-2 align-items-end">
                    <div class="flex-grow-1">
                        <textarea 
                            name="message" 
                            id="message-input"
                            class="form-control" 
                            placeholder="Type your message here..." 
                            rows="1" 
                            style="resize: none; max-height: 120px;"
                            required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary px-3" id="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom scrollbar */
#chat-messages::-webkit-scrollbar {
    width: 8px;
}

#chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Message animations */
.message {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Typing indicator */
.typing-dots {
    display: inline-block;
    position: relative;
    width: 40px;
    height: 10px;
    margin-right: 8px;
}

.typing-dots span {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #999;
    margin: 0 1px;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { 
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% { 
        transform: scale(1);
        opacity: 1;
    }
}

/* Message status icons */
.fa-check-double.text-info {
    color: #17a2b8 !important;
}

/* Dark Mode Chat Styles */
.dark-mode #chat-messages {
    background-color: #1f2937;
    border: 1px solid #374151;
}

.dark-mode .card-header {
    background-color: #374151 !important;
    border-bottom: 1px solid #4b5563;
}

.dark-mode .card-footer {
    background-color: #374151;
    border-top: 1px solid #4b5563;
}

.dark-mode .message-bubble.bg-light {
    background-color: #4b5563 !important;
    color: white;
}

.dark-mode .message-bubble.bg-primary {
    background-color: #3b82f6 !important;
}

.dark-mode .form-control {
    background-color: #374151;
    border: 1px solid #4b5563;
    color: white;
}

.dark-mode .form-control:focus {
    background-color: #374151;
    border-color: #3b82f6;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.dark-mode .form-control::placeholder {
    color: #9ca3af;
}

.dark-mode .text-muted {
    color: #6b7280 !important;
}

/* Better scrollbar for dark mode */
.dark-mode #chat-messages::-webkit-scrollbar-track {
    background: #374151;
}

.dark-mode #chat-messages::-webkit-scrollbar-thumb {
    background: #4b5563;
}

.dark-mode #chat-messages::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
}

/* Loading spinner */
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #ffffff50;
    border-radius: 50%;
    border-top-color: #ffffff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        updateDarkModeToggle();
    }
    
    const chatMessages = document.getElementById('chat-messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const connectionStatus = document.getElementById('connection-status');
    
    // Scroll to bottom of chat
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    scrollToBottom();
    
    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Submit on Enter (but not Shift+Enter)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Handle form submission
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // Send message function
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Disable send button and show loading
        sendButton.disabled = true;
        sendButton.innerHTML = '<div class="loading-spinner"></div>';
        
        // Send message via API
        fetch('/api/chat/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                recipient_id: {{ user_id }},
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // Add message to chat
                addMessageToChat(data.message, true);
                scrollToBottom();
            } else {
                throw new Error(data.error || 'Failed to send message');
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('Failed to send message: ' + error.message);
        })
        .finally(() => {
            // Re-enable send button
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            messageInput.focus();
        });
    }
    
    // Add message to chat UI
    function addMessageToChat(message, isFromCurrentUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message mb-3 ${isFromCurrentUser ? 'text-end' : ''}`;
        
        const bubbleClass = isFromCurrentUser ? 'bg-primary text-white ms-auto' : 'bg-light';
        const timeClass = isFromCurrentUser ? 'text-white-50' : 'text-muted';
        
        messageDiv.innerHTML = `
            <div class="message-bubble ${bubbleClass}" style="display: inline-block; padding: 10px 15px; border-radius: 18px; max-width: 70%; word-wrap: break-word;">
                <div class="message-content">${escapeHtml(message.message)}</div>
                <small class="message-time d-block mt-1 ${timeClass}">
                    ${formatTime(message.created_at)}
                    ${isFromCurrentUser ? '<i class="fas fa-check ms-1"></i>' : ''}
                </small>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
    }
    
    // Load new messages periodically
    function loadNewMessages() {
        fetch(`/api/chat/get_messages/{{ user_id }}`)
        .then(response => response.json())
        .then(data => {
            if (data.messages) {
                updateConnectionStatus(true);
                // Here you would compare with existing messages and add only new ones
                // For simplicity, we'll just indicate the connection is working
            }
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            updateConnectionStatus(false);
        });
    }
    
    // Update connection status
    function updateConnectionStatus(connected) {
        if (connected) {
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'badge bg-success ms-2';
        } else {
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.className = 'badge bg-danger ms-2';
        }
    }
    
    // Utility functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatTime(timeString) {
        const date = new Date(timeString);
        return date.toLocaleString('en-US', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    }
    
    // Auto-refresh messages every 30 seconds
    setInterval(loadNewMessages, 30000);
    
    // Focus on message input
    messageInput.focus();
});

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    updateDarkModeToggle();
}

function updateDarkModeToggle() {
    const toggle = document.getElementById('darkModeToggle');
    const icon = toggle.querySelector('i');
    const text = toggle.querySelector('span');
    
    if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun me-1';
        if (text) text.textContent = 'Light Mode';
        toggle.classList.remove('btn-outline-secondary');
        toggle.classList.add('btn-outline-warning');
    } else {
        icon.className = 'fas fa-moon me-1';
        if (text) text.textContent = 'Dark Mode';
        toggle.classList.remove('btn-outline-warning');
        toggle.classList.add('btn-outline-secondary');
    }
}
</script>
            </div>
            <div class="card-footer">
                <form method="POST" action="{{ url_for('send_chat_message', user_id=other_user.id) }}">
                    {{ form.hidden_tag() }}
                    <div class="input-group">
                        {{ form.message(class="form-control", placeholder="Type your message...", rows="2") }}
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                            Send
                        </button>
                    </div>
                    {% if form.message.errors %}
                        <div class="text-danger mt-1">
                            {% for error in form.message.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.message-bubble {
    word-wrap: break-word;
    word-break: break-word;
}

#chat-messages {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
}

.message {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Dark Mode Chat Styles */
.dark-mode #chat-messages {
    background-color: #1f2937;
    border: 1px solid #374151;
}

.dark-mode .card-header {
    background-color: #374151 !important;
    border-bottom: 1px solid #4b5563;
}

.dark-mode .card-footer {
    background-color: #374151;
    border-top: 1px solid #4b5563;
}

.dark-mode .message-bubble.bg-light {
    background-color: #4b5563 !important;
    color: white;
}

.dark-mode .message-bubble.bg-primary {
    background-color: #3b82f6 !important;
}

.dark-mode .form-control {
    background-color: #374151;
    border: 1px solid #4b5563;
    color: white;
}

.dark-mode .form-control:focus {
    background-color: #374151;
    border-color: #3b82f6;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.dark-mode .form-control::placeholder {
    color: #9ca3af;
}

.dark-mode .text-muted {
    color: #9ca3af !important;
}

.dark-mode .btn-secondary {
    background-color: #4b5563;
    border-color: #4b5563;
    color: white;
}

.dark-mode .btn-secondary:hover {
    background-color: #6b7280;
    border-color: #6b7280;
}

.dark-mode .btn-outline-secondary {
    color: #9ca3af;
    border-color: #4b5563;
}

.dark-mode .btn-outline-secondary:hover {
    background-color: #4b5563;
    border-color: #4b5563;
    color: white;
}

.dark-mode .btn-outline-warning {
    color: #fbbf24;
    border-color: #f59e0b;
}

.dark-mode .btn-outline-warning:hover {
    background-color: #f59e0b;
    border-color: #f59e0b;
    color: #1f2937;
}

/* Chat message timestamps in dark mode */
.dark-mode .message-time.text-muted {
    color: #9ca3af !important;
}

.dark-mode .message-time.text-white-50 {
    color: rgba(255, 255, 255, 0.7) !important;
}

/* Empty state styling */
.dark-mode .fa-comment-dots.text-muted {
    color: #6b7280 !important;
}

/* Better scrollbar for dark mode */
.dark-mode #chat-messages::-webkit-scrollbar {
    width: 8px;
}

.dark-mode #chat-messages::-webkit-scrollbar-track {
    background: #374151;
}

.dark-mode #chat-messages::-webkit-scrollbar-thumb {
    background: #4b5563;
    border-radius: 4px;
}

.dark-mode #chat-messages::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        updateDarkModeToggle();
    }
    
    // Scroll to bottom of chat
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Auto-resize textarea
    const textarea = document.querySelector('textarea[name="message"]');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        
        // Submit on Enter (but not Shift+Enter)
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.closest('form').submit();
            }
        });
    }
    
    // Auto-refresh messages every 10 seconds
    setInterval(function() {
        // In a real application, you might want to use WebSockets or Server-Sent Events
        // For now, we'll just indicate that messages might be outdated
        console.log('Auto-refresh would happen here');
    }, 10000);
});

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    updateDarkModeToggle();
}

function updateDarkModeToggle() {
    const toggle = document.getElementById('darkModeToggle');
    const icon = toggle.querySelector('i');
    const text = toggle.querySelector('span');
    
    if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun me-1';
        if (text) text.textContent = 'Light Mode';
        toggle.classList.remove('btn-outline-secondary');
        toggle.classList.add('btn-outline-warning');
    } else {
        icon.className = 'fas fa-moon me-1';
        if (text) text.textContent = 'Dark Mode';
        toggle.classList.remove('btn-outline-warning');
        toggle.classList.add('btn-outline-secondary');
    }
}
</script>
{% endblock %}
